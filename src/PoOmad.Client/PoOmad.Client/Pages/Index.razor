@page "/"
@using PoOmad.Shared.DTOs
@inject Services.ApiClient ApiClient
@inject Services.AuthStateService AuthState
@inject NavigationManager Navigation

<PageTitle>PoOmad - Dashboard</PageTitle>

<div class="dashboard">
    <h1>Welcome to PoOmad!</h1>
    
    @if (isLoading)
    {
        <p>Loading...</p>
    }
    else if (userInfo != null && userInfo.IsAuthenticated)
    {
        <div class="user-info">
            <p>Logged in as: @userInfo.Email</p>
            <button @onclick="SignOut" class="btn-signout">Sign Out</button>
        </div>

        @if (!userInfo.HasProfile)
        {
            <p>Redirecting to setup...</p>
        }
        else
        {
            <StreakCounter />
            <CalendarGrid />
        }
    }
    else
    {
        <p>Redirecting to sign in...</p>
    }
</div>

@code {
    private UserInfoDto? userInfo;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            userInfo = await ApiClient.GetCurrentUserAsync();
            
            if (userInfo?.IsAuthenticated == true)
            {
                AuthState.SetUser(userInfo);
                
                if (!userInfo.HasProfile)
                {
                    Navigation.NavigateTo("/setup");
                }
            }
            else
            {
                Navigation.NavigateTo("/auth");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading user info: {ex.Message}");
            Navigation.NavigateTo("/auth");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SignOut()
    {
        await ApiClient.SignOutAsync();
        AuthState.ClearUser();
        Navigation.NavigateTo("/auth");
    }
}

<style>
    .dashboard {
        padding: 2rem;
        max-width: 1200px;
        margin: 0 auto;
        color: #fff;
    }

    .user-info {
        margin: 1rem 0;
        padding: 1rem;
        background: #2a2a2a;
        border-radius: 4px;
    }

    .btn-signout {
        margin-top: 0.5rem;
        padding: 8px 16px;
        background: #d32f2f;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-signout:hover {
        background: #b71c1c;
    }
</style>
